<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ニュース - ELM PORT</title>
  <meta name="description" content="北海道大学の最新ニュース、アルバイト情報、就職情報、掲示板">
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=Noto+Serif+JP:wght@500;700&display=swap" rel="stylesheet">
  <!-- Theme -->
  <link rel="stylesheet" href="/nu-theme.css">
  <script defer src="/nu-tweaks.js"></script>

  <style>
    
    .tabs{
      background:#fff;border-bottom:1px solid var(--line);
      position:sticky;top:70px;z-index:40;
    }
    .tabs-content{max-width:var(--container);margin:auto;display:flex;gap:2rem;padding:0 20px}
    .tab{padding:14px 0;cursor:pointer;border-bottom:3px solid transparent;color:var(--muted)}
    .tab.active{color:var(--nu-green);border-bottom-color:var(--nu-green)}
    .filters{background:#fff;border:1px solid var(--line);border-radius:12px;margin:16px auto;max-width:var(--container);padding:12px}
    .filter-buttons{display:flex;flex-wrap:wrap;gap:10px}
    .filter-btn{padding:8px 14px;border:1px solid var(--line);border-radius:20px;background:#fff}
    .filter-btn.active,.filter-btn:hover{border-color:var(--nu-green);color:var(--nu-green)}
    .articles-container{max-width:var(--container);margin:auto;padding:0 20px}
    .article-card{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--line);cursor:pointer}
    .article-card:hover{background:var(--surface)}
    .article-content{flex:1}
    .article-date{font-size:.9rem;font-weight:600;color:#111}
    .new-badge{background:#e11d48;color:#fff;font-size:.7rem;padding:2px 6px;border-radius:4px}
    .article-title{font-size:1rem;font-weight:700;margin:2px 0 4px}
    .article-subtitle{color:var(--muted);font-size:.9rem;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .article-meta{display:flex;gap:8px;align-items:center;font-size:.8rem;color:var(--muted)}
    .by-badge{background:#111;color:#fff;border-radius:4px;font-size:.7rem;padding:2px 6px}
    .article-genre{color:#065f46;font-weight:600}
    .article-thumbnail{width:140px;height:78px;border-radius:10px;object-fit:cover;background:var(--surface)}
    .load-more{display:block;margin:24px auto;padding:10px 22px;border:2px solid var(--nu-green);border-radius:30px;background:#fff;color:var(--nu-green);font-weight:700}
    .load-more:hover{background:var(--nu-green);color:#fff}
    .no-articles,.error{padding:48px;text-align:center;color:var(--muted)}
    /* モーダル */
    .modal{display:none;position:fixed;inset:0;background:#0006;z-index:1000;overflow:auto}
    .modal.active{display:block}
    .modal-content{background:#fff;max-width:860px;margin:40px auto;border-radius:14px;overflow:hidden;animation:slideUp .25s ease}
    @keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{padding:12px 16px;border-bottom:1px solid var(--line);position:relative}
    .modal-close{position:absolute;right:12px;top:12px;width:36px;height:36px;border:none;border-radius:50%;background:var(--surface);cursor:pointer}
    .modal-body{padding:18px}
    .article-detail-image{width:100%;max-height:420px;object-fit:cover;border-radius:10px;margin-bottom:12px}
    .article-detail-title{font-size:1.6rem;margin:4px 0 6px}
    .article-detail-subtitle{color:var(--muted);margin:0 0 12px}
    .comments-section{margin-top:22px;padding-top:18px;border-top:1px solid var(--line)}
    .comment{background:var(--surface);padding:12px;border-radius:10px;margin-bottom:10px}
    .comment-meta{display:flex;justify-content:space-between;color:var(--muted);font-size:.9rem}
    /* ローディングスピナー */
    .spinner-container{min-height:80px;display:flex;justify-content:center;align-items:center}
    .spinner{width:36px;height:36px;border:4px solid var(--line);border-top-color:var(--nu-green);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* ヒーロー */
    .hero{background:linear-gradient(180deg, var(--nu-green), var(--nu-green-600));color:#fff;padding:48px 0}
    .hero-inner{max-width:var(--container);margin:auto;padding:0 20px}
    .hero h1{margin:0 0 6px}
    @media (max-width:860px){
      .tabs{top:70px}
      .article-card{flex-direction:column}
      .article-thumbnail{width:100%;height:200px}
      .modal-content{margin:0;border-radius:0;min-height:100vh}
    }
  </style>
</head>
<body>
  <!-- 共通ヘッダー -->
  <div class="topbar" aria-hidden="true"></div>
  <header class="site-header" role="banner">
    <div class="container hdr-inner">
<a class="brand" href="/">
  <!-- 画像アイコンを使用 -->
  <span class="brand-icon" aria-hidden="true">
    <img src="/images/logo.png" alt="ELM PORT">
  </span>
  
  <span class="brand-text">
    <strong>ELM PORT</strong>
    <small>Campus Life Support for Hokkaido Univ.</small>
  </span>
</a>
      <button class="nav-toggle" aria-expanded="false" aria-controls="site-nav">メニュー</button>
<nav id="site-nav" class="site-nav" role="navigation">
  <ul>
    <li><a href="/"          data-path="/">ホーム</a></li>
    <li><a href="/news"      data-path="/news">ニュース</a></li>
    <li><a href="/updates"   data-path="/updates">更新情報</a></li>
    <li><a href="/sns"       data-path="/sns">SNS</a></li>
    <li><a href="/contact"   data-path="/contact">お問い合わせ</a></li>
  </ul>
</nav>
    </div>
  </header>

  <!-- ヒーロー -->
  <section class="hero">
    <div class="hero-inner">
      <h1>ニュース</h1>
      <p>記事・アルバイト・掲示板の最新情報</p>
    </div>
  </section>

  <!-- タブ -->
  <div class="tabs">
    <div class="tabs-content">
      <div class="tab active" data-featured="article">記事</div>
      <div class="tab" data-featured="arbeit">アルバイト</div>
      <div class="tab" data-featured="work">仕事</div>
      <div class="tab" data-featured="board">掲示板</div>
    </div>
  </div>

  <!-- フィルター -->
  <div class="filters">
    <div class="filter-buttons">
      <button class="filter-btn active" data-status="published">最新の記事</button>
      <button class="filter-btn" data-status="archived">過去の記事</button>
    </div>
  </div>

  <!-- 記事リスト -->
  <div class="articles-container" id="articles">
    <div style="display:flex;justify-content:center;align-items:center;min-height:240px">
      <div class="spinner" style="width:44px;height:44px;border:4px solid var(--line);border-top-color:var(--nu-green);border-radius:50%;animation:spin .8s linear infinite"></div>
    </div>
  </div>
  <button class="load-more" id="loadMore" style="display:none">もっと読む</button>

  <!-- モーダル -->
  <div class="modal" id="articleModal">
    <div class="modal-content">
      <div class="modal-header"><button class="modal-close" onclick="closeModal()">✕</button></div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- 共通フッター -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div><div class="brand small"><span class="brand-mark" aria-hidden="true"></span><strong>ELM PORT</strong></div>
        <p class="muted">© 2025 ELM PORT Team</p></div>
      <nav aria-label="フッターメニュー">
        <ul>
          <li><a href="/updates">更新情報</a></li>
          <li><a href="/contact">お問い合わせ</a></li>
          <li><a href="/term">利用規約</a></li>
          <li><a href="/privacyporicy">プライバシー</a></li>
        </ul>
      </nav>
    </div>
  </footer>

  <script>
    // ===== 設定 =====
    const API_BASE = '';               // 同一ドメインにリバースプロキシする場合は空のまま
    const DB_PARAM = '?db=1';
    const CF_ACCOUNT = 'ogAIW_Vdq_bAijSDyryXCQ'; // そのまま流用

    // ===== ユーティリティ =====
    function cfImg(id){ if(!id||id.includes('null')) return ''; if(id.startsWith('http')) return id; return `https://imagedelivery.net/${CF_ACCOUNT}/${id}/public`; }
    function formatDate(ts){ const d=new Date(ts); const now=new Date(); const days=Math.floor((now-d)/(864e5)); return {dateStr:`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`,isNew:days<=3}; }
    function relTime(ts){ const d=new Date(ts),now=new Date(),diff=now-d; const m=Math.floor(diff/6e4),h=Math.floor(diff/36e5),dd=Math.floor(diff/864e5); if(m<1)return'たった今'; if(m<60)return`${m}分前`; if(h<24)return`${h}時間前`; return`${dd}日前`; }
    function escapeHtml(t){ const div=document.createElement('div'); div.textContent=t??''; return div.innerHTML; }
    function md(content){
      if(!content) return '';
      content = escapeHtml(content)
        .replace(/^### (.*?)$/gm,'<h3>$1</h3>')
        .replace(/^## (.*?)$/gm,'<h2>$1</h2>')
        .replace(/^# (.*?)$/gm,'<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>')
        .replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');
      return `<p>${content}</p>`;
    }

    // ===== 状態 =====
    let allArticles=[], filtered=[], currentFeatured='article', currentStatus='published', visible=6, currentArticle=null, currentComments=[];

    // ===== データ取得 =====
    async function fetchArticles(){
      try{
        const r=await fetch(`${API_BASE}/api/articles${DB_PARAM}`);
        const data=await r.json();
        allArticles=data; applyFilter(); render();
      }catch(e){
        console.error(e);
        document.getElementById('articles').innerHTML='<div class="error">記事の読み込みに失敗しました。</div>';
      }
    }
    function applyFilter(){
      filtered=allArticles.filter(a=>a.featured===currentFeatured&&a.status===currentStatus);
      filtered.sort((a,b)=>{const at=!!(a.thumbnailUrl&&!a.thumbnailUrl.includes('/null')), bt=!!(b.thumbnailUrl&&!b.thumbnailUrl.includes('/null')); if(at&&!bt) return -1; if(!at&&bt) return 1; return (b.createdAt||0)-(a.createdAt||0);});
      visible=6;
    }
    function render(){
      const c=document.getElementById('articles');
      const arr=filtered.slice(0,visible);
      if(arr.length===0){ c.innerHTML='<div class="no-articles">記事がありません</div>'; document.getElementById('loadMore').style.display='none'; return; }
      c.innerHTML=arr.map(a=>{
        const {dateStr,isNew}=formatDate(a.updatedAt||a.createdAt);
        const thumb=a.thumbnailUrl?cfImg(a.thumbnailUrl):'';
        const has=thumb&&!thumb.includes('/null');
        return `
        <div class="article-card" onclick="showArticle('${a.id}')">
          <div class="article-content">
            <div class="article-date-row"><span class="article-date">${dateStr}</span> ${isNew?'<span class="new-badge">New!</span>':''}</div>
            <h3 class="article-title">${escapeHtml(a.title)}</h3>
            ${a.subtitle?`<p class="article-subtitle">${escapeHtml(a.subtitle)}</p>`:''}
            <div class="article-meta">
              <span class="by-badge">By</span><span>${escapeHtml(a.author||'Anonymous')}</span>
              <span class="article-genre">${escapeHtml(a.genre||'未分類')}</span>
            </div>
          </div>
          ${has?`<img class="article-thumbnail" src="${thumb}" alt="">`:''}
        </div>`;
      }).join('');
      document.getElementById('loadMore').style.display = filtered.length>visible ? 'block':'none';
    }

    async function showArticle(id){
      const a=allArticles.find(x=>x.id===id); if(!a) return; currentArticle=a;
      incrementView(id);
      const img=a.imageUrl||a.thumbnailUrl; const url=img?cfImg(img):'';
      document.getElementById('modalBody').innerHTML = `
        ${url&&!url.includes('/null')?`<img class="article-detail-image" src="${url}" alt="">`:''}
        <h1 class="article-detail-title">${escapeHtml(a.title)}</h1>
        ${a.subtitle?`<p class="article-detail-subtitle">${escapeHtml(a.subtitle)}</p>`:''}
        <div class="article-detail-content">${md(a.content)}</div>
        ${a.commentsEnabled?`
          <div class="comments-section" id="commentsSection">
            <h3 class="comments-title">コメント欄</h3>
            <div id="commentsList">
              <div class="spinner-container">
                <div class="spinner"></div>
              </div>
            </div>
            <div class="comment-form" style="margin-top:12px">
              <input type="text" class="form-input" id="nameInput" placeholder="お名前（省略可）" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px">
              <textarea class="form-input" id="commentInput" rows="3" placeholder="コメントを入力" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px"></textarea>
              <button class="btn btn-solid" style="margin-top:8px" onclick="postComment()">送信</button>
            </div>
          </div>`:''
        }`;
      document.getElementById('articleModal').classList.add('active'); document.body.style.overflow='hidden';
      if(a.commentsEnabled) loadComments(id);
    }
    function closeModal(){ document.getElementById('articleModal').classList.remove('active'); document.body.style.overflow=''; currentArticle=null; currentComments=[]; }
    async function incrementView(id){ try{ await fetch(`${API_BASE}/api/articles/${id}/view${DB_PARAM}`,{method:'POST'});}catch{} }
    async function loadComments(id){
      try{ const r=await fetch(`${API_BASE}/api/articles/${id}/comments${DB_PARAM}`); currentComments=await r.json(); renderComments(); }
      catch{ document.getElementById('commentsList').innerHTML='<div class="error">コメントの読み込みに失敗しました</div>'; }
    }
    function renderComments(){
      const c=document.getElementById('commentsList');
      if(!currentComments.length){ c.innerHTML='<p class="muted" style="text-align:center">まだコメントはありません</p>'; return; }
      c.innerHTML=currentComments.map(cm=>`
        <div class="comment">
          <p>${escapeHtml(cm.body)}</p>
          <div class="comment-meta"><span>${escapeHtml(cm.author||'Anonymous')} • ${relTime(cm.createdAt)}</span><span>👍 ${cm.likes||0}</span></div>
        </div>`).join('');
    }
    function getFP(){ let fp=localStorage.getItem('fp'); if(!fp){ fp=crypto.randomUUID(); localStorage.setItem('fp',fp);} return fp; }
    async function postComment(){
      const body=(document.getElementById('commentInput').value||'').trim(); if(!body){ alert('コメントを入力してください'); return; }
      const name=(document.getElementById('nameInput').value||'').trim()||'Anonymous';
      try{
        const r=await fetch(`/api/articles/${currentArticle.id}/comments${DB_PARAM}`,{method:'POST',headers:{'Content-Type':'application/json','x-client-fingerprint':getFP()},body:JSON.stringify({body,author:name})});
        if(r.ok){ document.getElementById('commentInput').value=''; document.getElementById('nameInput').value=''; loadComments(currentArticle.id); }
      }catch{ alert('コメントの投稿に失敗しました'); }
    }

    // 画面イベント
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',e=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active'); currentFeatured=e.currentTarget.dataset.featured; applyFilter(); render();
      }));
      document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',e=>{
        document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active'); currentStatus=e.currentTarget.dataset.status; applyFilter(); render();
      }));
      document.getElementById('loadMore').addEventListener('click',()=>{ visible+=6; render(); });
      document.getElementById('articleModal').addEventListener('click',e=>{ if(e.target.id==='articleModal') closeModal();});
      document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
      fetchArticles();
    });
  </script>
</body>
</html>